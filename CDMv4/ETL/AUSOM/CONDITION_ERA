-- Calculation of Condition Era using MSSQL
-- by Man Young Park, PhD, Ajou University School of Medicine
-- Korean in this file will be changed into English later.

set NOCOUNT on

--그렇다면, 같은 성분을 가진 약물은??? ancestor를 가지고 진행하면 됨.
drop table CONDITION_ERA_STEP1
select * into CONDITION_ERA_STEP1 from (
SELECT  *,ROW_NUMBER() over (PARTITION BY person_id,CONDITION_concept_id ORDER by CONDITION_START_DATE) as ordRk  FROM [DBO].CONDITION_OCCURRENCE
)v
go

drop table CONDITION_ERA_STEP1_TMP
DROP TABLE CONDITION_ERA_STEP1_TMP
SELECT * INTO CONDITION_ERA_STEP1_TMP FROM (
SELECT CONDITION_OCCURRENCE_ID,PERSON_ID,CONDITION_CONCEPT_ID,CONDITION_START_DATE,CONDITION_END_DATE=CASE WHEN CONDITION_END_DATE IS NULL THEN CONDITION_START_DATE ELSE CONDITION_END_DATE END,ORDRK
FROM CONDITION_ERA_STEP1
)V ORDER BY PERSON_ID,CONDITION_CONCEPT_ID,CONDITION_START_DATE
GO


DROP TABLE CONDITION_ERA_STEP2_TMP
SELECT * INTO CONDITION_ERA_STEP2_TMP FROM (
SELECT A.*,B.CONDITION_START_DATE AS CONDITION_START_DATE2, B.CONDITION_END_DATE AS CONDITION_END_DATE2, 
DATEDIFF(DD,A.CONDITION_END_DATE,B.CONDITION_START_DATE) AS DAYS FROM CONDITION_ERA_STEP1_TMP A LEFT JOIN CONDITION_ERA_STEP1_TMP B 
ON A.PERSON_ID=B.PERSON_ID AND A.CONDITION_CONCEPT_ID=B.CONDITION_CONCEPT_ID AND A.ORDRK=CAST(B.ORDRK AS INT)-1

)V ORDER BY V.PERSON_ID,V.CONDITION_CONCEPT_ID,V.CONDITION_START_DATE
GO


drop table CONDITION_ERA_STEP3_TMP
select * into CONDITION_ERA_STEP3_TMP FROM (
select *,fg=CASE WHEN [days]<30  then 1
                 when  (select [days] from CONDITION_ERA_STEP2_TMP a WHERE a.person_id=b.person_id and a.CONDITION_CONCEPT_ID=b.CONDITION_CONCEPT_ID and a.ordrk=b.ordrk-1)<30 THEN 1000 end
,fg2=null
from CONDITION_ERA_STEP2_TMP b
)v
go

drop table CONDITION_ERA_STEP4_tmp_null
SELECT * INTO CONDITION_ERA_STEP4_tmp_null FROM (
SELECT * FROM CONDITION_ERA_STEP3_tmp WHERE FG IS NULL
)V
go

drop table CONDITION_ERA_STEP4_tmp_notnull
SELECT * INTO CONDITION_ERA_STEP4_tmp_notnull FROM (
SELECT * FROM CONDITION_ERA_STEP3_tmp WHERE FG IS NOT NULL
)V
go


create index CONDITION_ERA_STEP4_tmp_notnull_idx on CONDITION_ERA_STEP4_tmp_notnull(CONDITION_OCCURRENCE_ID)

--커서오픈

--################## Grouping by Cursor #######################################
--커서선언
DECLARE CUR_PMY CURSOR
FOR
SELECT CONDITION_OCCURRENCE_ID,[PERSON_ID],[FG]
FROM CONDITION_ERA_STEP4_TMP_NOTNULL ORDER BY PERSON_ID,CONDITION_CONCEPT_ID,CONDITION_START_DATE
--커서오픈
OPEN CUR_PMY
--변수선언
DECLARE @CONDITION_OCCURRENCE_ID VARCHAR(10)
DECLARE @PERSON_ID VARCHAR(10)
DECLARE @FG INT
DECLARE @I INT
 
FETCH NEXT FROM CUR_PMY INTO @CONDITION_OCCURRENCE_ID,@PERSON_ID,@FG
SET @I=1

WHILE @@FETCH_STATUS = 0
BEGIN

IF @FG=1 OR @FG=1000
 BEGIN 
	UPDATE CONDITION_ERA_STEP4_TMP_NOTNULL SET FG2=@I WHERE CONDITION_OCCURRENCE_ID=@CONDITION_OCCURRENCE_ID
 END

IF @FG IS NULL OR @FG=1000 
BEGIN 
	SET @I=@I+1	
END


FETCH NEXT FROM CUR_PMY INTO @CONDITION_OCCURRENCE_ID,@PERSON_ID,@FG
END
CLOSE CUR_PMY
DEALLOCATE CUR_PMY
GO
--################## End of Grouping by Cursor ######################################




DROP TABLE CONDITION_ERA 
SELECT  IDENTITY(INT,1,1)  AS CONDITION_ERA_ID, * INTO CONDITION_ERA FROM (
SELECT 
PERSON_ID,
CONDITION_CONCEPT_ID,
min(CONDITION_start_date) as CONDITION_ERA_START_DATE,
max(CONDITION_end_date) as  CONDITION_ERA_END_DATE,
CONDITION_TYPE_CONCEPT_ID=null,
count(*) AS CONDITION_OCCURRENCE_COUNT
FROM CONDITION_ERA_STEP4_tmp_notnull 
group by PERSON_ID, CONDITION_CONCEPT_ID,fg2

union 

select PERSON_ID,CONDITION_CONCEPT_ID,CONDITION_start_date as CONDITION_ERA_START_DATE,CONDITION_end_date as  CONDITION_ERA_END_DATE,
 CONDITION_TYPE_CONCEPT_ID=null,
 CONDITION_OCCURRENCE_COUNT=1
 from CONDITION_ERA_STEP4_tmp_null

)V --(2048744개 행이 영향을 받음)


CREATE INDEX CONDITION_ERA_IDX ON CONDITION_ERA(PERSON_ID,CONDITION_ERA_START_DATE)


--걸리는 시간 체크
select count(*) from CONDITION_ERA_STEP4_TMP_NOTNULL where fg2 is not null

select convert(varchar(10),cast(1.0*count(*)/2739430*100 as numeric(5,2))) +'%'
from CONDITION_ERA_STEP4_TMP_NOTNULL where fg2 is not null


select count(distinct CONDITION_CONCEPT_ID) from CONDITION_OCCURRENCE

select count(distinct CONDITION_CONCEPT_ID) from CONDITION_ERA

